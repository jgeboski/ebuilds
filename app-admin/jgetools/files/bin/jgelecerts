#!/bin/bash

CERTROOT=${CERTROOT:-/etc/ssl/lecerts}
WWWPATH=${WWWPATH:-${CERTROOT}/www}
LEUSER=${LEUSER:-lecerts}
LEGROUP=${LEGROUP:-lecerts}
TESTING=${TESTING:-no}

JGELIBDIR=${JGELIBDIR:-/usr/share/jgetools}
source "${JGELIBDIR}/common.sh"
set -e

SLEPLUGINS=(
    account_key.json
    cert.der
    cert.pem
    chain.der
    chain.pem
    external.sh,
    fullchain.der
    fullchain.pem
    key.der
    key.pem
)

leusage() {
    echo "Usages:" >&2
    echo "  jgelecerts create <domain> <user> <plugins...> [additional...]" >&2
    echo "  jgelecerts revoke <domain>" >&2
    echo "  jgelecerts update" >&2
    jge_log_error "invalid command syntax"
}

slecmd() {
    SLEARGS="${@:2}"

    if [ "${TESTING}" == "yes" ]; then
        SLEARGS+=" --server https://acme-staging.api.letsencrypt.org/directory"
    fi

    echo "simp_le ${SLEARGS}"

    if ! su -c "cd \"${1}\" && simp_le ${SLEARGS}" - "${LEUSER}"; then
        return 1
    fi
}

leisplugin() {
    PLUGIN="${1}"

    for SLEPLUGIN in ${SLEPLUGINS[@]}; do
        if [ "${SLEPLUGIN}" == "${PLUGIN}" ]; then
            return
        fi
    done

    return 1
}

ledomplug() {
    DOMAINS=()
    PLUGINS=()

    for ARG in ${@}; do
        if leisplugin "${ARG}"; then
            PLUGINS+=(${ARG})
        else
            DOMAINS+=(${ARG})
        fi
    done

    DOMAINS="${DOMAINS[@]}"
    PLUGINS="${PLUGINS[@]}"
}

led2a() {
    DOMAINDIR="${1}"
    DOMAIN=$(basename "${DOMAINDIR}")
    DOMAINS=$(cat "${DOMAINDIR}/.domains")
    RETARGS=""

    for DOMAIN in ${DOMAIN} ${DOMAINS}; do
        if [ -n "${RETARGS}" ]; then
            RETARGS+=" "
        fi

        RETARGS+="-d \"${DOMAIN}:${WWWPATH}\""
    done

    for PLUGIN in ${SLEPLUGINS[@]}; do
        if ! [ -e "${DOMAINDIR}/${PLUGIN}" ]; then
            continue
        fi

        if [ -n "${RETARGS}" ]; then
            RETARGS+=" "
        fi

        RETARGS+="-f ${PLUGIN}"
    done

    echo "${RETARGS}"
}

lea2a() {
    RETARGS=""

    for ARG in ${@}; do
        if [ -n "${RETARGS}" ] ; then
            RETARGS+=" "
        fi

        if leisplugin "${ARG}"; then
            RETARGS+="-f ${PLUGIN}"
        else
            RETARGS+="-d \"${ARG}:${WWWPATH}\""
        fi
    done

    echo "${RETARGS}"
}

lecreate() {
    DOMAIN="${1}"
    MYUSER="${2}"
    DOMAINDIR="${CERTROOT}/${DOMAIN}"
    ledomplug "${@:3}"

    [ -n "${DOMAIN}" ] && [ -n "${MYUSER}" ] && [ -n "${PLUGINS}" ] || leusage
    [ -e "${DOMAINDIR}" ] && jge_log_error "${DOMAIN} already exists"

    mkdir -p "${WWWPATH}"
    chown "${LEUSER}:${LEGROUP}" "${WWWPATH}"
    chmod 755 "${WWWPATH}"

    mkdir -p "${DOMAINDIR}"
    chmod 570 "${DOMAINDIR}"
    chown "${MYUSER}:${LEGROUP}" "${DOMAINDIR}"

    if [ -e "${CERTROOT}/account_key.json" ]; then
        ln -sf "../account_key.json" "${DOMAINDIR}"
        EMAIL=""
    else
        if [ -z "${EMAIL}" ]; then
            rm -rf "${DOMAINDIR}"
            jge_log_error "First time usage requires the EMAIL variable"
        fi

        EMAIL="--email \"${EMAIL}\""
    fi

    PLUGINS+=" account_key.json"
    SLEARGS="${EMAIL} $(lea2a ${DOMAIN} ${DOMAINS} ${PLUGINS})"

    if ! slecmd "${DOMAINDIR}" "${SLEARGS}"; then
        rm -rf "${DOMAINDIR}"
    fi

    if ! [ -e "${CERTROOT}/account_key.json" ]; then
        mv "${DOMAINDIR}/account_key.json" ${CERTROOT}
        chmod 600 "${CERTROOT}/account_key.json"
        ln -sf "../account_key.json" "${DOMAINDIR}"
    fi

    for DOMAIN in ${DOMAINS}; do
        echo "${DOMAIN}" >> "${DOMAINDIR}/.domains"
    done
}

lerevoke() {
    DOMAIN="${1}"
    DOMAINDIR="${CERTROOT}/${DOMAIN}"

    [ -n "${DOMAIN}" ] || leusage
    [ -e "${DOMAINDIR}" ] || jge_log_error "${DOMAIN} does not exist"

    SLEARGS="--revoke $(led2a ${DOMAINDIR})"

    if slecmd "${DOMAINDIR}" "${SLEARGS}"; then
        rm -rf "${DOMAINDIR}"
    fi
}

leupdate() {
    DOMAINS=$(find "${CERTROOT}" -maxdepth 1 -type d -name '*.*' -exec basename {} \;)
    RETVAL=1

    for DOMAIN in ${DOMAINS}; do
        DOMAINDIR="${CERTROOT}/${DOMAIN}"
        SLEARGS=$(led2a "${DOMAINDIR}")

        if slecmd "${DOMAINDIR}" "${SLEARGS}"; then
            RETVAL=0
        fi
    done

    return ${RETVAL}
}

jge_require_user root

if [ "${TESTING}" == "yes" ]; then
    if [ -e "${CERTROOT}" -a ! -e "${CERTROOT}/.testing" ]; then
        jge_log_error "${CERTROOT} is setup for production"
    fi

    mkdir -p "${CERTROOT}"
    touch "${CERTROOT}/.testing"
elif [ -e "${CERTROOT}/.testing" ]; then
    jge_log_error "${CERTROOT} is setup for testing"
fi

case "${1}" in
    create) lecreate "${2}" "${3}" "${@:4}" ;;
    revoke) lerevoke "${2}" ;;
    update) leupdate ;;
    *) leusage ;;
esac

exit $?
